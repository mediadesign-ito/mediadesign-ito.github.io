<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Routing Fix Version</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { width: 100%; height: 100vh; z-index: 1; }

        #controls {
            position: absolute; top: 10px; left: 10px; z-index: 1000;
            background: white; padding: 15px; border-radius: 4px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.65);
            max-width: 300px; width: 100%; box-sizing: border-box;
        }

        #results-panel {
            position: absolute; top: 10px; right: 10px; z-index: 1000;
            background: white; border-radius: 4px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.65);
            width: 320px; max-height: 90vh; overflow-y: auto;
            display: none;
        }

        .list-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; }
        .list-item:hover { background-color: #e3f2fd; }
        .list-header { font-weight: bold; color: #0078A8; display: flex; justify-content: space-between; }
        .list-address { font-size: 0.85rem; color: #555; margin-left: 10px; margin-top: 4px; }
        
        button {
            background-color: #d32f2f; color: white; border: none;
            padding: 10px; border-radius: 4px; cursor: pointer; width: 100%; font-weight: bold;
        }
        button:disabled { background-color: #ccc; }
        
        /* çµŒè·¯æ¡ˆå†…ï¼ˆå³æŠ˜ãƒ»å·¦æŠ˜ãªã©ã®æ–‡å­—ï¼‰ã‚’éš ã™è¨­å®š */
        .leaflet-routing-container { display: none; }

        @media (max-width: 700px) {
            #results-panel { top: auto; bottom: 0; left: 0; right: 0; width: 100%; max-height: 40vh; }
        }
    </style>
</head>
<body>

    <div id="controls">
        <h3>é¿é›£æ‰€ãƒãƒƒãƒ—</h3>
        <p style="font-size:0.9rem;">CSVèª­è¾¼: <span id="status-text">å¾…æ©Ÿä¸­...</span></p>
        <button id="btn-nearest" disabled>ğŸ“ ç¾åœ¨åœ°ã‚’å–å¾—ï¼†ãƒªã‚¹ãƒˆè¡¨ç¤º</button>
    </div>

    <div id="results-panel">
        <div style="padding:10px; font-weight:bold; background:#f5f5f5;">è¿‘éš£ã‚¹ãƒãƒƒãƒˆ Top 5</div>
        <div id="list-container"></div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <script>
        // â˜…CSVãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆåŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«ç½®ã„ã¦ãã ã•ã„ï¼‰
        const CSV_FILE_PATH = 'data.csv';

        // åœ°å›³åˆæœŸåŒ–
        const map = L.map('map').setView([35.681236, 139.767125], 5);
        L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
            attribution: 'åœ°ç†é™¢ã‚¿ã‚¤ãƒ«', minZoom: 2, maxZoom: 18
        }).addTo(map);

        let csvLayer = L.layerGroup().addTo(map);
        let currentLocLayer = L.layerGroup().addTo(map);
        let routingControl = null;
        let allCsvData = [];
        let currentUserLocation = null;

        const redIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
        });

        // 1. ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«CSVå–å¾—
        window.addEventListener('load', () => {
            const status = document.getElementById('status-text');
            status.innerText = "èª­è¾¼ä¸­...";
            
            Papa.parse(CSV_FILE_PATH, {
                download: true, header: true, skipEmptyLines: true,
                complete: (results) => {
                    const data = results.data;
                    allCsvData = data.map(row => ({
                        lat: parseFloat(row['ç·¯åº¦'] || row['latitude'] || row['lat']),
                        lng: parseFloat(row['çµŒåº¦'] || row['longitude'] || row['lng']),
                        name: row['åç§°'] || row['æ–½è¨­å'] || '',
                        address: row['ä½æ‰€'] || row['æ‰€åœ¨åœ°'] || '',
                        disaster: row['é¿é›£å¯¾è±¡ã®ç½å®³'] || ''
                    })).filter(d => !isNaN(d.lat) && !isNaN(d.lng));

                    if(allCsvData.length > 0) {
                        status.innerText = "å®Œäº† (" + allCsvData.length + "ä»¶)";
                        status.style.color = "green";
                        document.getElementById('btn-nearest').disabled = false;
                        displayMarkers(allCsvData);
                        map.fitBounds(allCsvData.map(d => [d.lat, d.lng]));
                    } else {
                        status.innerText = "ãƒ‡ãƒ¼ã‚¿ãªã—";
                    }
                },
                error: (err) => {
                    console.error(err);
                    status.innerText = "ã‚¨ãƒ©ãƒ¼";
                    status.style.color = "red";
                    alert("CSVèª­ã¿è¾¼ã¿å¤±æ•—: ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼çµŒç”±ã§é–‹ã„ã¦ã„ã¾ã™ã‹ï¼Ÿ");
                }
            });
        });

        // 2. ç¾åœ¨åœ°æ¤œç´¢ãƒœã‚¿ãƒ³
        document.getElementById('btn-nearest').addEventListener('click', function() {
            if(!navigator.geolocation) return alert("ä½ç½®æƒ…å ±éå¯¾å¿œ");
            
            const btn = this;
            btn.innerText = "æ¤œç´¢ä¸­...";
            btn.disabled = true;

            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    currentUserLocation = { lat, lng };
                    const currentLatLng = L.latLng(lat, lng);

                    // ç¾åœ¨åœ°ãƒ”ãƒ³
                    currentLocLayer.clearLayers();
                    L.marker([lat, lng], {icon: redIcon}).bindPopup("<b>ç¾åœ¨åœ°</b>").addTo(currentLocLayer).openPopup();

                    // è·é›¢è¨ˆç®— & ã‚½ãƒ¼ãƒˆ
                    const nearData = allCsvData.map(d => {
                        d.distance = currentLatLng.distanceTo([d.lat, d.lng]);
                        return d;
                    }).sort((a,b) => a.distance - b.distance).slice(0, 5);

                    // è¡¨ç¤ºæ›´æ–°
                    displayMarkers(nearData);
                    updateList(nearData);
                    
                    // ã‚ºãƒ¼ãƒ 
                    const bounds = L.latLngBounds([currentLatLng]);
                    nearData.forEach(d => bounds.extend([d.lat, d.lng]));
                    map.fitBounds(bounds, {padding: [50,50]});

                    btn.innerText = "ğŸ“ ç¾åœ¨åœ°ã‚’å–å¾—ï¼†ãƒªã‚¹ãƒˆè¡¨ç¤º";
                    btn.disabled = false;
                },
                (err) => {
                    alert("ä½ç½®æƒ…å ±ã‚¨ãƒ©ãƒ¼: " + err.message);
                    btn.innerText = "ğŸ“ ç¾åœ¨åœ°ã‚’å–å¾—ï¼†ãƒªã‚¹ãƒˆè¡¨ç¤º";
                    btn.disabled = false;
                }
            );
        });

        function displayMarkers(list) {
            csvLayer.clearLayers();
            list.forEach(d => {
                const marker = L.marker([d.lat, d.lng]);
                marker.bindPopup(`<b>${d.name}</b><br>${d.address}<br>${d.disaster}`);
                d.markerObject = marker;
                marker.addTo(csvLayer);
            });
        }

        function updateList(list) {
            const container = document.getElementById('list-container');
            container.innerHTML = "";
            document.getElementById('results-panel').style.display = 'block';

            list.forEach((d, i) => {
                const dist = d.distance >= 1000 ? (d.distance/1000).toFixed(1)+"km" : Math.round(d.distance)+"m";
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    <div class="list-header"><span>${i+1}. ${d.name}</span><span style="font-size:0.8rem; background:#eee; padding:2px 5px; border-radius:4px;">${dist}</span></div>
                    <div class="list-address">${d.address}</div>
                `;
                // ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‹•ä½œ
                div.addEventListener('click', () => {
                    map.flyTo([d.lat, d.lng], 16);
                    if(d.markerObject) d.markerObject.openPopup();
                    
                    // â˜…çµŒè·¯æ¤œç´¢ã®å®Ÿè¡Œ
                    if(currentUserLocation) {
                        drawRoute(currentUserLocation, d);
                    } else {
                        alert("ç¾åœ¨åœ°ãŒå–å¾—ã•ã‚Œã¦ã„ã¾ã›ã‚“");
                    }
                });
                container.appendChild(div);
            });
        }

        // 3. ãƒ«ãƒ¼ãƒˆæç”»é–¢æ•°ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–ç‰ˆï¼‰
        function drawRoute(start, end) {
            // æ—¢å­˜ã®ãƒ«ãƒ¼ãƒˆãŒã‚ã‚Œã°æ¶ˆã™
            if (routingControl) {
                map.removeControl(routingControl);
            }

            // ãƒ«ãƒ¼ãƒˆæ¤œç´¢ã®å®Ÿè¡Œ
            routingControl = L.Routing.control({
                waypoints: [
                    L.latLng(start.lat, start.lng),
                    L.latLng(end.lat, end.lng)
                ],
                // OSRMã‚µãƒ¼ãƒãƒ¼ã‚’æ˜ç¤ºçš„ã«æŒ‡å®š
                router: L.Routing.osrmv1({
                    serviceUrl: 'https://router.project-osrm.org/route/v1'
                }),
                // ç·šã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆé’è‰²ã€ä¸é€æ˜åº¦0.6ã€å¤ªã•6pxï¼‰
                lineOptions: {
                    styles: [{color: 'red', opacity: 0.8, weight: 8}]
                },
                // ãƒãƒ¼ã‚«ãƒ¼ã¯ç‹¬è‡ªã«è¡¨ç¤ºã—ã¦ã„ã‚‹ã®ã§ãƒ«ãƒ¼ãƒˆç”¨ãƒãƒ¼ã‚«ãƒ¼ã¯éè¡¨ç¤º
                createMarker: function() { return null; },
                addWaypoints: false,
                draggableWaypoints: false,
                fitSelectedRoutes: true, // ãƒ«ãƒ¼ãƒˆå…¨ä½“ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«è‡ªå‹•ã‚ºãƒ¼ãƒ 
                showAlternatives: false
            })
            .on('routingerror', function(e) {
                // â˜…ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã®é€šçŸ¥
                console.error('Routing Error:', e);
                alert('çµŒè·¯ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nè€ƒãˆã‚‰ã‚Œã‚‹åŸå› :\nãƒ»ã‚µãƒ¼ãƒãƒ¼(OSRM)ãŒæ··é›‘ã—ã¦ã„ã‚‹\nãƒ»è·é›¢ãŒé ã™ãã‚‹\nãƒ»æµ·ã‚’ã¾ãŸã„ã§ã„ã‚‹');
            })
            .addTo(map);
        }
    </script>
</body>
</html>
