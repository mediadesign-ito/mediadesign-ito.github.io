<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Slide Panel Map Viewer</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; overflow: hidden; background: #f0f0f0; }
        
        /* 地図設定 */
        #map { width: 100%; height: 100vh; z-index: 1; }

        /* 上部バー */
        #top-bar {
            position: absolute; top: 10px; left: 10px; z-index: 1000;
            background: white; padding: 8px 12px;
            border-radius: 4px; box-shadow: 0 1px 4px rgba(0,0,0,0.3);
            display: flex; align-items: center; gap: 15px;
        }
        h1 { margin: 0; font-size: 1.1rem; color: #333; font-weight: bold; white-space: nowrap; }
        #btn-current {
            background-color: #d32f2f; color: white; border: none;
            padding: 6px 15px; border-radius: 4px; cursor: pointer;
            font-size: 0.9rem; font-weight: bold; white-space: nowrap;
        }
        #btn-current:hover { background-color: #b71c1c; }
        #btn-current:disabled { background-color: #ccc; cursor: not-allowed; }

        /* --- スライドパネル全体 --- */
        #results-panel {
            position: absolute;
            z-index: 2000; /* 地図よりかなり手前 */
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            display: none; /* 最初は非表示 */
            transition: transform 0.3s ease-in-out, height 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
        }

        /* PC表示: 右上にフロート表示 */
        @media (min-width: 601px) {
            #results-panel {
                top: 60px; right: 10px;
                width: 320px;
                max-height: 80vh;
                border-radius: 4px;
            }
            /* PCで閉じたときはリスト部分を隠す */
            #results-panel.closed #list-container {
                display: none;
            }
        }

        /* スマホ表示: 下部に固定 */
        @media (max-width: 600px) {
            #results-panel {
                top: auto; bottom: 0; left: 0; right: 0;
                width: 100%;
                height: 50vh; /* 開いたときの高さ */
                border-radius: 15px 15px 0 0; /* 上だけ丸く */
                transform: translateY(0); /* 通常位置 */
            }
            /* スマホで閉じたときは下にスライドして隠す */
            #results-panel.closed {
                /* ヘッダーの高さ(約45px)だけ残して下に埋める */
                transform: translateY(calc(100% - 45px));
            }
        }

        /* パネルのヘッダー（クリックして開閉する部分） */
        #panel-header {
            padding: 12px 15px;
            background: #f9f9f9;
            border-bottom: 1px solid #ddd;
            font-weight: bold;
            color: #333;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            /* スマホ用の角丸対応 */
            border-radius: 4px 4px 0 0; 
        }
        @media (max-width: 600px) {
            #panel-header { border-radius: 15px 15px 0 0; }
        }

        /* 開閉アイコン */
        #toggle-icon {
            transition: transform 0.3s;
            font-size: 0.8rem;
            color: #666;
        }
        /* 閉じたときはアイコンを回転 */
        #results-panel.closed #toggle-icon {
            transform: rotate(180deg);
        }

        /* リスト部分（スクロール可能エリア） */
        #list-container {
            flex: 1; /* 残りの高さを埋める */
            overflow-y: auto;
            background: #fff;
        }

        /* リストアイテム */
        .list-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .list-item:hover { background-color: #f0f8ff; }

        .list-header { font-weight: bold; font-size: 0.95rem; color: #0078A8; display: flex; justify-content: space-between; }
        .list-dist { font-size: 0.8rem; background: #eee; padding: 2px 6px; border-radius: 10px; color: #333; }
        .list-detail { font-size: 0.85rem; color: #555; margin-top: 4px; line-height: 1.4; }

        .leaflet-routing-container { display: none; }
    </style>
</head>
<body>

    <!-- 上部バー -->
    <div id="top-bar">
        <h1>避難所マップ</h1>
        <button id="btn-current" disabled>現在地</button>
    </div>

    <!-- 全体開閉式パネル -->
    <div id="results-panel" class="closed" style="display:none;">
        <!-- ヘッダー（ここをクリックで開閉） -->
        <div id="panel-header">
            <span id="header-title">近くの避難所 (Top 5)</span>
            <span id="toggle-icon">▼</span>
        </div>
        <!-- リスト中身 -->
        <div id="list-container">
            <!-- JSで追加 -->
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <script>
        const CSV_FILE_PATH = 'data.csv';

        const map = L.map('map', {zoomControl: false}).setView([35.681236, 139.767125], 5);
        L.control.zoom({ position: 'bottomright' }).addTo(map);
        L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
            attribution: '地理院タイル', minZoom: 2, maxZoom: 18
        }).addTo(map);

        let csvLayer = L.layerGroup().addTo(map);
        let currentLocLayer = L.layerGroup().addTo(map);
        let routingControl = null;
        let allCsvData = [];
        let currentUserLocation = null;

        const redIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
        });

        // 1. CSV読み込み
        window.addEventListener('load', () => {
            Papa.parse(CSV_FILE_PATH, {
                download: true, header: true, skipEmptyLines: true,
                complete: (results) => {
                    allCsvData = results.data.map(row => ({
                        lat: parseFloat(row['緯度'] || row['latitude'] || row['lat']),
                        lng: parseFloat(row['経度'] || row['longitude'] || row['lng']),
                        name: row['名称'] || row['施設名'] || '',
                        address: row['住所'] || row['所在地'] || '',
                        disaster: row['避難対象の災害'] || ''
                    })).filter(d => !isNaN(d.lat) && !isNaN(d.lng));

                    if(allCsvData.length > 0) {
                        document.getElementById('btn-current').disabled = false;
                        displayMarkers(allCsvData);
                    }
                },
                error: () => alert("CSV読込エラー: サーバー経由で開いてください")
            });
        });

        // 2. 現在地検索
        document.getElementById('btn-current').addEventListener('click', function() {
            if(!navigator.geolocation) return alert("位置情報不可");
            
            const btn = this;
            const originalText = btn.innerText;
            btn.innerText = "取得中...";
            btn.disabled = true;

            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    currentUserLocation = { lat, lng };
                    const currentLatLng = L.latLng(lat, lng);

                    currentLocLayer.clearLayers();
                    L.marker([lat, lng], {icon: redIcon}).bindPopup("<b>現在地</b>").addTo(currentLocLayer).openPopup();

                    const nearData = allCsvData.map(d => {
                        d.distance = currentLatLng.distanceTo([d.lat, d.lng]);
                        return d;
                    }).sort((a,b) => a.distance - b.distance).slice(0, 5);

                    displayMarkers(nearData);
                    updateList(nearData);
                    
                    const bounds = L.latLngBounds([currentLatLng]);
                    nearData.forEach(d => bounds.extend([d.lat, d.lng]));
                    map.fitBounds(bounds, {padding: [50, 50]});

                    btn.innerText = originalText;
                    btn.disabled = false;
                },
                (err) => {
                    alert("位置情報取得エラー");
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            );
        });

        function displayMarkers(list) {
            csvLayer.clearLayers();
            list.forEach(d => {
                const marker = L.marker([d.lat, d.lng]);
                marker.bindPopup(`<b>${d.name}</b><br>${d.address}`);
                d.markerObject = marker;
                marker.addTo(csvLayer);
            });
        }

        // 3. パネル開閉ロジック
        const panel = document.getElementById('results-panel');
        const header = document.getElementById('panel-header');
        
        // ヘッダーをクリックしたらクラスを切り替える
        header.addEventListener('click', () => {
            panel.classList.toggle('closed');
        });

        // リスト更新関数
        function updateList(list) {
            const container = document.getElementById('list-container');
            container.innerHTML = "";
            
            // パネルを表示し、自動で開く（closedクラスを外す）
            panel.style.display = 'flex';
            panel.classList.remove('closed');

            list.forEach((d, i) => {
                const dist = d.distance >= 1000 ? (d.distance/1000).toFixed(1)+"km" : Math.round(d.distance)+"m";
                
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    <div class="list-header">
                        <span>${i+1}. ${d.name}</span>
                        <span class="list-dist">${dist}</span>
                    </div>
                    <div class="list-detail">
                        ${d.address}<br>
                        <span style="color:#d32f2f;">${d.disaster}</span>
                    </div>
                `;
                
                div.addEventListener('click', () => {
                    // クリックしたらPC/スマホともに地図が見やすいように自動でパネルを閉じる（任意）
                    // panel.classList.add('closed'); 
                    
                    map.flyTo([d.lat, d.lng], 16);
                    if(d.markerObject) d.markerObject.openPopup();
                    if(currentUserLocation) drawRoute(currentUserLocation, d);
                });
                
                container.appendChild(div);
            });
        }

        function drawRoute(start, end) {
            if (routingControl) map.removeControl(routingControl);
            routingControl = L.Routing.control({
                waypoints: [ L.latLng(start.lat, start.lng), L.latLng(end.lat, end.lng) ],
                router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' }),
                lineOptions: { styles: [{color: '#0066ff', opacity: 0.7, weight: 6}] },
                createMarker: () => null,
                addWaypoints: false, draggableWaypoints: false, fitSelectedRoutes: true
            }).addTo(map);
        }
    </script>
</body>
</html>