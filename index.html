<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nearest 5 List Viewer</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        
        #map {
            width: 100%;
            height: 100vh;
            z-index: 1;
        }

        /* å·¦å´ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« */
        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 4px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.65);
            max-width: 300px;
            width: 100%;
            box-sizing: border-box;
        }

        /* å³å´ã®çµæœãƒªã‚¹ãƒˆãƒ‘ãƒãƒ« */
        #results-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            border-radius: 4px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.65);
            width: 320px;
            max-height: 90vh; /* ç”»é¢ã‹ã‚‰ã¯ã¿å‡ºãªã„ã‚ˆã†ã« */
            overflow-y: auto; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã« */
            display: none; /* æœ€åˆã¯éè¡¨ç¤º */
        }

        /* ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .list-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }
        .list-item:last-child {
            border-bottom: none;
        }
        .list-item:hover {
            background-color: #f5f5f5;
        }

        /* ãƒªã‚¹ãƒˆå†…ã®æ–‡å­—ã‚¹ã‚¿ã‚¤ãƒ« */
        .list-header {
            font-weight: bold;
            font-size: 1rem;
            color: #0078A8;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between; /* åç§°ã¨è·é›¢ã‚’å·¦å³ã«é…ç½® */
        }
        .list-address {
            font-size: 0.85rem;
            color: #555;
            margin-left: 1.2rem; /* ç•ªå·ã®åˆ†ã ã‘ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆ */
        }
        .list-dist {
            font-size: 0.8rem;
            color: #d32f2f;
            background: #ffebee;
            padding: 2px 6px;
            border-radius: 4px;
            white-space: nowrap;
            margin-left: 8px;
        }

        /* ãƒœã‚¿ãƒ³ç­‰ */
        .note { font-size: 0.8rem; color: #666; margin-bottom: 10px; }
        button {
            background-color: #d32f2f; color: white; border: none;
            padding: 10px 15px; border-radius: 4px; cursor: pointer;
            font-size: 0.95rem; width: 100%; font-weight: bold;
        }
        button:hover { background-color: #b71c1c; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        
        /* ã‚¹ãƒãƒ›å¯¾å¿œ: ç”»é¢ãŒç‹­ã„ã¨ãã¯ãƒªã‚¹ãƒˆã‚’ä¸‹ã«é…ç½® */
        @media (max-width: 700px) {
            #results-panel {
                top: auto;
                bottom: 0;
                right: 0;
                left: 0;
                width: 100%;
                max-height: 40vh;
                border-radius: 10px 10px 0 0;
            }
        }
    </style>
</head>
<body>

    <!-- æ“ä½œãƒ‘ãƒãƒ« -->
    <div id="controls">
        <label for="csv-file"><b>1. CSVèª­ã¿è¾¼ã¿:</b></label>
        <input type="file" id="csv-file" accept=".csv" style="margin-top:5px; margin-bottom:10px; width:100%;">
        <hr style="border:0; border-top:1px solid #eee; margin:10px 0;">
        <b>2. è¿‘éš£æ¤œç´¢:</b>
        <div class="note">â€»ç¾åœ¨åœ°ã‹ã‚‰è¿‘ã„5ä»¶ã‚’è¡¨ç¤ºã—ã¾ã™</div>
        <button id="btn-nearest">ğŸ“ ç¾åœ¨åœ°ã‚’å–å¾—ï¼†ãƒªã‚¹ãƒˆè¡¨ç¤º</button>
    </div>

    <!-- çµæœãƒªã‚¹ãƒˆãƒ‘ãƒãƒ«ï¼ˆæœ€åˆã¯éè¡¨ç¤ºï¼‰ -->
    <div id="results-panel">
        <div style="padding:10px; background:#f9f9f9; border-bottom:1px solid #ddd; font-weight:bold;">
            è¿‘éš£ã‚¹ãƒãƒƒãƒˆ (Top 5)
        </div>
        <div id="list-container">
            <!-- ã“ã“ã«JavaScriptã§ãƒªã‚¹ãƒˆãŒè¿½åŠ ã•ã‚Œã¾ã™ -->
        </div>
    </div>

    <div id="map"></div>

    <!-- Leaflet JS & PapaParse -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <script>
        // --- 1. åœ°å›³ã®åˆæœŸåŒ– ---
        const map = L.map('map').setView([35.681236, 139.767125], 5);

        L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
            attribution: '<a href="https://maps.gsi.go.jp/development/ichiran.html" target="_blank">åœ°ç†é™¢ã‚¿ã‚¤ãƒ«</a>',
            minZoom: 2, maxZoom: 18
        }).addTo(map);

        let csvLayer = L.layerGroup().addTo(map);
        let currentLocLayer = L.layerGroup().addTo(map);
        let allCsvData = [];

        // èµ¤ã„ãƒãƒ¼ã‚«ãƒ¼ï¼ˆç¾åœ¨åœ°ç”¨ï¼‰
        const redIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
        });

        // --- 2. CSVèª­ã¿è¾¼ã¿ ---
        document.getElementById('csv-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            // ãƒªã‚»ãƒƒãƒˆ
            csvLayer.clearLayers();
            currentLocLayer.clearLayers();
            allCsvData = [];
            document.getElementById('results-panel').style.display = 'none';

            Papa.parse(file, {
                header: true, skipEmptyLines: true,
                complete: function(results) {
                    const data = results.data;
                    data.forEach((row) => {
                        const lat = parseFloat(row['ç·¯åº¦'] || row['latitude'] || row['lat']);
                        const lng = parseFloat(row['çµŒåº¦'] || row['longitude'] || row['lng']);
                        if (!isNaN(lat) && !isNaN(lng)) {
                            allCsvData.push({
                                lat: lat, lng: lng,
                                name: row['åç§°'] || row['æ–½è¨­å'] || row['Name'] || '',
                                address: row['ä½æ‰€'] || row['æ‰€åœ¨åœ°'] || row['Address'] || '',
                                disaster: row['é¿é›£å¯¾è±¡ã®ç½å®³'] || row['ç½å®³ç¨®åˆ¥'] || ''
                            });
                        }
                    });

                    if (allCsvData.length > 0) {
                        displayMarkers(allCsvData); // å…¨ä»¶è¡¨ç¤º
                        const latLngs = allCsvData.map(d => [d.lat, d.lng]);
                        map.fitBounds(latLngs);
                    } else {
                        alert("æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
                    }
                }
            });
        });

        // --- 3. ç¾åœ¨åœ°å–å¾—ã¨ãƒªã‚¹ãƒˆè¡¨ç¤ºå‡¦ç† ---
        document.getElementById('btn-nearest').addEventListener('click', function() {
            if (allCsvData.length === 0) { alert("å…ˆã«CSVã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„"); return; }
            if (!navigator.geolocation) { alert("ä½ç½®æƒ…å ±éå¯¾å¿œã§ã™"); return; }

            const btn = this;
            btn.innerHTML = "æ¤œç´¢ä¸­...";
            btn.disabled = true;

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const currentLat = position.coords.latitude;
                    const currentLng = position.coords.longitude;
                    const currentLatLng = L.latLng(currentLat, currentLng);

                    // ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼
                    currentLocLayer.clearLayers();
                    L.marker([currentLat, currentLng], {icon: redIcon})
                        .bindPopup("<b>ã‚ãªãŸã®ç¾åœ¨åœ°</b>")
                        .addTo(currentLocLayer)
                        .openPopup();

                    // è·é›¢è¨ˆç®—ã¨ã‚½ãƒ¼ãƒˆ
                    const dataWithDistance = allCsvData.map(point => {
                        point.distance = currentLatLng.distanceTo(L.latLng(point.lat, point.lng));
                        return point;
                    });
                    
                    dataWithDistance.sort((a, b) => a.distance - b.distance);
                    const nearest5 = dataWithDistance.slice(0, 5);

                    // åœ°å›³æ›´æ–°
                    displayMarkers(nearest5);
                    
                    // â˜…ãƒªã‚¹ãƒˆæ›´æ–°
                    updateResultList(nearest5);

                    // ã‚ºãƒ¼ãƒ èª¿æ•´
                    const bounds = L.latLngBounds([currentLatLng]);
                    nearest5.forEach(d => bounds.extend([d.lat, d.lng]));
                    map.fitBounds(bounds, {padding: [50, 50]});

                    btn.innerHTML = "ğŸ“ ç¾åœ¨åœ°ã‚’å–å¾—ï¼†ãƒªã‚¹ãƒˆè¡¨ç¤º";
                    btn.disabled = false;
                },
                function(error) {
                    alert("ä½ç½®æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼");
                    btn.innerHTML = "ğŸ“ ç¾åœ¨åœ°ã‚’å–å¾—ï¼†ãƒªã‚¹ãƒˆè¡¨ç¤º";
                    btn.disabled = false;
                }
            );
        });

        // --- 4. åœ°å›³ã¸ã®ãƒãƒ¼ã‚«ãƒ¼è¡¨ç¤º ---
        function displayMarkers(points) {
            csvLayer.clearLayers();
            points.forEach((point) => {
                // ãƒãƒ¼ã‚«ãƒ¼ä½œæˆ
                const marker = L.marker([point.lat, point.lng]);
                
                // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å†…å®¹
                let popupHTML = `<b>${point.name}</b><br>ä½æ‰€: ${point.address}`;
                if (point.disaster) popupHTML += `<br>ç½å®³: ${point.disaster}`;
                
                marker.bindPopup(popupHTML);
                
                // ãƒãƒ¼ã‚«ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ‡ãƒ¼ã‚¿ã«é–¢é€£ä»˜ã‘ã¦ãŠãï¼ˆãƒªã‚¹ãƒˆã‚¯ãƒªãƒƒã‚¯æ™‚ã®ãŸã‚ï¼‰
                point.markerObject = marker; 
                
                marker.addTo(csvLayer);
            });
        }

        // --- 5. ãƒªã‚¹ãƒˆç”Ÿæˆé–¢æ•° (è¦æœ›ã®ã‚¹ã‚¿ã‚¤ãƒ«) ---
        function updateResultList(points) {
            const panel = document.getElementById('results-panel');
            const container = document.getElementById('list-container');
            
            container.innerHTML = ""; // ã‚¯ãƒªã‚¢
            panel.style.display = 'block'; // è¡¨ç¤º

            points.forEach((point, index) => {
                // è·é›¢ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                let distStr = "";
                if (point.distance >= 1000) {
                    distStr = (point.distance / 1000).toFixed(1) + " km";
                } else {
                    distStr = Math.round(point.distance) + " m";
                }

                // ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã®ä½œæˆ
                const itemDiv = document.createElement('div');
                itemDiv.className = 'list-item';
                
                // HTMLæ§‹é€ : 
                // 1 åç§° 500m
                // ä½æ‰€
                itemDiv.innerHTML = `
                    <div class="list-header">
                        <span>${index + 1}. ${point.name}</span>
                        <span class="list-dist">${distStr}</span>
                    </div>
                    <div class="list-address">${point.address}</div>
                `;

                // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ: åœ°å›³ä¸Šã®ãƒãƒ¼ã‚«ãƒ¼ã¸ç§»å‹•ã—ã¦ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—
                itemDiv.addEventListener('click', () => {
                    map.flyTo([point.lat, point.lng], 16); // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç§»å‹•
                    if (point.markerObject) {
                        point.markerObject.openPopup();
                    }
                });

                container.appendChild(itemDiv);
            });
        }
    </script>
</body>
</html>