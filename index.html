<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>避難所はどこだ？</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; overflow: hidden; background: #f0f0f0; }
        
        /* 地図設定 */
        #map { width: 100%; height: 100vh; z-index: 1; }

        /* 上部バー */
        #top-bar {
            position: absolute; top: 10px; left: 10px; z-index: 1000;
            background: white; padding: 8px 12px;
            border-radius: 4px; box-shadow: 0 1px 4px rgba(0,0,0,0.3);
            display: flex; align-items: center; gap: 10px;
        }
        h1 { margin: 0; font-size: 1.1rem; color: #333; font-weight: bold; white-space: nowrap; margin-right: 5px; }
        
        #btn-current {
            background-color: #d32f2f; color: white; border: none;
            padding: 6px 12px; border-radius: 4px; cursor: pointer;
            font-size: 0.9rem; font-weight: bold; white-space: nowrap;
        }
        #btn-current:hover { background-color: #b71c1c; }

        #btn-help {
            background-color: #0078A8; color: white; border: none;
            padding: 6px 12px; border-radius: 4px; cursor: pointer;
            font-size: 0.9rem; font-weight: bold; white-space: nowrap;
        }
        #btn-help:hover { background-color: #005f85; }

        /* --- スタート画面（モーダル） --- */
        #welcome-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            z-index: 99999;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 8px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-title { 
            font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; 
            color: #d32f2f; border-bottom: 2px solid #d32f2f; padding-bottom: 5px; 
        }
        .modal-section { margin-bottom: 20px; }
        .modal-h3 { font-size: 1rem; font-weight: bold; margin-bottom: 8px; color: #333; background: #eee; padding: 5px; border-radius: 4px;}
        .modal-text { font-size: 0.9rem; color: #555; line-height: 1.6; margin-bottom: 10px; }
        
        #btn-agree {
            width: 100%; padding: 15px;
            background-color: #d32f2f; color: white;
            border: none; border-radius: 4px;
            font-size: 1.1rem; font-weight: bold;
            cursor: pointer; margin-top: 10px;
        }
        #btn-agree:hover { background-color: #b71c1c; }

        /* --- スライドパネル全体 --- */
        #results-panel {
            position: absolute; z-index: 2000; background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            display: none; transition: transform 0.3s ease-in-out;
            display: flex; flex-direction: column;
        }

        @media (min-width: 601px) {
            #results-panel {
                top: 80px; left: 10px; width: 320px; max-height: 80vh; border-radius: 4px;
            }
            #results-panel.closed #list-container { display: none; }
        }

        @media (max-width: 600px) {
            #top-bar { gap: 5px; }
            h1 { font-size: 1rem; }
            #results-panel {
                top: auto; bottom: 0; left: 0; right: 0; width: 100%; height: 50vh;
                border-radius: 15px 15px 0 0; transform: translateY(0);
            }
            #results-panel.closed { transform: translateY(calc(100% - 45px)); }
        }

        #panel-header {
            padding: 12px 15px; background: #f9f9f9; border-bottom: 1px solid #ddd;
            font-weight: bold; color: #333; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
            border-radius: 4px 4px 0 0;
        }
        @media (max-width: 600px) { #panel-header { border-radius: 15px 15px 0 0; } }

        #toggle-icon { transition: transform 0.3s; font-size: 0.8rem; color: #666; }
        #results-panel.closed #toggle-icon { transform: rotate(180deg); }

        #list-container { flex: 1; overflow-y: auto; background: #fff; }
        .list-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; }
        .list-item:hover { background-color: #f0f8ff; }
        .list-header { font-weight: bold; font-size: 0.95rem; color: #0078A8; display: flex; justify-content: space-between; }
        .list-dist { font-size: 0.8rem; background: #eee; padding: 2px 6px; border-radius: 10px; color: #333; }
        .list-detail { font-size: 0.85rem; color: #555; margin-top: 4px; line-height: 1.4; }

        .leaflet-routing-container { display: none; }
        .leaflet-control-attribution { background: rgba(255, 255, 255, 0.8) !important; padding: 0 5px; }
    </style>
</head>
<body>

    <!-- スタート画面（モーダル） -->
    <div id="welcome-modal">
        <div class="modal-content">
            <div class="modal-title">避難所はどこだ？</div>
            
            <div class="modal-section">
                <div class="modal-h3">使い方</div>
                <div class="modal-text">
                    1. 画面左上の「現在地」ボタンを押してください。<br>
                    2. 近くの避難所（5件）が地図とリストに表示されます。<br>
                    3. リストをタップすると、そこまでの経路が表示されます。
                </div>
            </div>

            <div class="modal-section">
                <div class="modal-h3">注意事項</div>
                <div class="modal-text">
                    <ul>
                        <li>位置情報の利用を許可してください。</li>
                        <li>表示される距離は目安です。</li>
                        <li>経路情報はオープンソースのOSRMデモサーバーを使用しています。</li>
                        <li>示される経路は必ずしも最短ではありません。実際の道路状況に従って避難してください。</li>
                    </ul>
                </div>
            </div>

            <div class="modal-section">
                <div class="modal-h3">出典・ライセンス</div>
                <div class="modal-text" style="font-size: 0.85rem; color: #666;">
                    出典：このコンテンツは、仙台市オープンデータポータルを利用しています<br>
                    ライセンス：CC ライセンス 表示 4.0 国際<br>
                    制作：メディアデザイン <a href="https://mediadesign.jp" target="_blank" style="color: #666;">https://mediadesign.jp</a>
                </div>
            </div>

            <button id="btn-agree" onclick="document.getElementById('welcome-modal').style.display='none';">同意して利用を開始する</button>
        </div>
    </div>

    <!-- 上部バー -->
    <div id="top-bar">
        <h1>避難所はどこだ？</h1>
        <button id="btn-current">現在地</button>
        <button id="btn-help">ヘルプ</button>
    </div>

    <!-- 結果表示パネル -->
    <div id="results-panel" class="closed" style="display:none;">
        <div id="panel-header">
            <span id="header-title">近くの避難所 (Top 5)</span>
            <span id="toggle-icon">▼</span>
        </div>
        <div id="list-container"></div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <script>
        const CSV_FILE_PATH = 'data.csv';

        // ヘルプボタン
        document.getElementById('btn-help').addEventListener('click', function() {
            const modal = document.getElementById('welcome-modal');
            const btnAgree = document.getElementById('btn-agree');
            modal.style.display = 'flex';
            btnAgree.innerText = "閉じる";
        });

        // 地図初期化
        const map = L.map('map', {
            zoomControl: false,
            attributionControl: false 
        }).setView([38.2682, 140.8694], 12);

        L.control.attribution({ position: 'topright' }).addTo(map);
        L.control.zoom({ position: 'topright' }).addTo(map);

        L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
            attribution: '地理院タイル', minZoom: 2, maxZoom: 18
        }).addTo(map);

        let csvLayer = L.layerGroup().addTo(map);
        let currentLocLayer = L.layerGroup().addTo(map);
        let routingControl = null;
        let allCsvData = [];
        let currentUserLocation = null;

        const redIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
        });

        // CSV読み込み
        window.addEventListener('load', () => {
            Papa.parse(CSV_FILE_PATH, {
                download: true, header: true, skipEmptyLines: true,
                complete: (results) => {
                    allCsvData = results.data.map(row => ({
                        lat: parseFloat(row['緯度'] || row['latitude'] || row['lat']),
                        lng: parseFloat(row['経度'] || row['longitude'] || row['lng']),
                        name: row['名称'] || row['施設名'] || '',
                        address: row['住所'] || row['所在地'] || '',
                        disaster: row['避難対象の災害'] || ''
                    })).filter(d => !isNaN(d.lat) && !isNaN(d.lng));
                }
            });
        });

        // 現在地検索
        document.getElementById('btn-current').addEventListener('click', function() {
            if (allCsvData.length === 0) {
                alert("データの読み込みが完了していません。サーバー経由で開いているか確認してください。");
                return;
            }

            if(!navigator.geolocation) return alert("位置情報に対応していません。");
            
            const btn = this;
            const originalText = btn.innerText;
            btn.innerText = "取得中...";
            btn.disabled = true;

            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    currentUserLocation = { lat, lng };
                    const currentLatLng = L.latLng(lat, lng);

                    currentLocLayer.clearLayers();
                    L.marker([lat, lng], {icon: redIcon}).bindPopup("<b>現在地</b>").addTo(currentLocLayer).openPopup();

                    const nearData = allCsvData.map(d => {
                        d.distance = currentLatLng.distanceTo([d.lat, d.lng]);
                        return d;
                    }).sort((a,b) => a.distance - b.distance).slice(0, 5);

                    displayMarkers(nearData);
                    updateList(nearData);
                    
                    const bounds = L.latLngBounds([currentLatLng]);
                    nearData.forEach(d => bounds.extend([d.lat, d.lng]));
                    map.fitBounds(bounds, {padding: [50, 50]});

                    btn.innerText = originalText;
                    btn.disabled = false;
                },
                (err) => {
                    alert("位置情報の取得に失敗しました。利用を許可してください。");
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            );
        });

        function displayMarkers(list) {
            csvLayer.clearLayers();
            list.forEach(d => {
                const marker = L.marker([d.lat, d.lng]);
                marker.bindPopup(`<b>${d.name}</b><br>${d.address}`);
                d.markerObject = marker;
                marker.addTo(csvLayer);
            });
        }

        const panel = document.getElementById('results-panel');
        const header = document.getElementById('panel-header');
        header.addEventListener('click', () => { panel.classList.toggle('closed'); });

        function updateList(list) {
            const container = document.getElementById('list-container');
            container.innerHTML = "";
            panel.style.display = 'flex';
            panel.classList.remove('closed');

            list.forEach((d, i) => {
                const dist = d.distance >= 1000 ? (d.distance/1000).toFixed(1)+"km" : Math.round(d.distance)+"m";
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    <div class="list-header">
                        <span>${i+1}. ${d.name}</span>
                        <span class="list-dist">${dist}</span>
                    </div>
                    <div class="list-detail">
                        ${d.address}<br><span style="color:#d32f2f;">${d.disaster}</span>
                    </div>
                `;
                div.addEventListener('click', () => {
                    map.flyTo([d.lat, d.lng], 16);
                    if(d.markerObject) d.markerObject.openPopup();
                    if(currentUserLocation) drawRoute(currentUserLocation, d);
                });
                container.appendChild(div);
            });
        }

        function drawRoute(start, end) {
            if (routingControl) map.removeControl(routingControl);
            routingControl = L.Routing.control({
                waypoints: [ L.latLng(start.lat, start.lng), L.latLng(end.lat, end.lng) ],
                router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' }),
                // ★線のスタイルを赤色の点線に変更
                lineOptions: { 
                    styles: [
                        { color: '#ff0000', opacity: 0.8, weight: 6, dashArray: '10, 10' } 
                    ] 
                },
                createMarker: () => null,
                addWaypoints: false, draggableWaypoints: false, fitSelectedRoutes: true
            }).addTo(map);
        }
    </script>
</body>
</html>